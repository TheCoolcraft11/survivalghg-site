<!DOCTYPE html>
<html lang="en">
<noscript>You need to enabled java script in order to run this site</noscript>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="fullscreen=*">
    <title>Console</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('./images/bg.webp');
            background-size: cover;
            background-position: center;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }


        .console {
            width: 75%;
            height: 75vh;
            min-width: 150vh;
            min-height: 75vh;
            background-color: black;
            color: white;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(3, 2, 2, 0.8);
            opacity: 0.67;
            margin-top: 20px;
            position: absolute;
            top: 9%;
            left: 7%;
            white-space: pre-wrap;
            display: block;
        }

        .console .message-div {
            display: block;
            white-space: pre-wrap;
        }

        .console div[data-type="joinorleft"] {
            color: lime;
        }

        .console div[data-type="chatmsg"] {
            color: cyan;
        }

        .console div[data-type="cmdexec"] {
            color: orange;
        }

        .console div[data-type="deathmsg"] {
            color: red;
        }

        .console div[data-type="warn"] {
            color: yellow;
            font-weight: bold;
        }

        .console div[data-type="error"] {
            color: darkred;
            font-weight: bold;
        }

        .console div[data-type="info"] {
            color: white;
        }

        .console div[data-type="other"] {
            color: white;
        }

        @keyframes fadeIn {
            from {
                background-color: yellow;
            }

            to {
                background-color: black;
            }
        }

        .new-message {
            animation: fadeIn 1s ease-out;
        }

        ::-webkit-scrollbar {
            width: 20px;
        }

        ::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px grey;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #222;
        }


        .button-container {
            margin-top: 90px;
            width: 80%;
            display: flex;
            justify-content: flex-end;
            padding-right: 10%;
            gap: 100px;
            margin-left: -1000px;
            position: absolute;
            bottom: 8%;
        }


        .btn {
            text-transform: uppercase;
            text-decoration: none;
            padding: 15px 10px;
            display: inline-block;
            border-radius: 100px;
            transition: all 0.2s;
            position: absolute;
            width: 75px;
            height: 20px;
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .btn::after {
            content: "";
            display: inline-block;
            height: 100%;
            width: 100%;
            border-radius: 100px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            transition: all 0.4s;
        }

        .btn:hover::after {
            transform: scaleX(1.4) scaleY(1.6);
            opacity: 0;
        }

        .btn-kill {
            background-color: #ac0000;
            color: #ffffff;
        }

        .btn-kill::after {
            background-color: #ac0000;
        }

        .btn-start {
            background-color: #00ab00;
            color: #ffffff;
        }

        .btn-start::after {
            background-color: #00ab00;
        }

        .btn-stop {
            background-color: #ff0000;
            color: #ffffff;
        }

        .btn-stop::after {
            background-color: #ff0000;
        }

        .btn-restart {
            background-color: #ff9100;
            color: #ffffff;
        }

        .btn-restart::after {
            background-color: #ff9100;
        }

        .btn-animated {
            animation: moveInBottom 5s ease-out;
            animation-fill-mode: backwards;
        }

        @keyframes moveInBottom {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .command-label {
            display: flex;
            position: absolute;
            border: 1px solid transparent;
            border-radius: 12px;
            background: black;
            cursor: text;
            width: 500px;
            height: 50px;
            opacity: 0.75;
            left: 7%;
            bottom: 3%;
        }

        .command-label:disabled {
            background: #1f1f1f;
        }

        .command-label[type="text"] {
            color: #ffffff;
        }

        .command-label::placeholder {
            font: 1.25rem/3 sans-serif;
        }

        .command-label:hover {
            border-color: gray;
        }

        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 0.6rem 2rem;
            display: flex;
            justify-content: center;
            background-color: rgba(28, 28, 28, 0.6);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-left {
            list-style: none;
            display: flex;
            gap: 2rem;
        }

        .nav-left li {
            font-size: 1.2rem;
        }

        .nav-left a {
            text-decoration: none;
            color: #fff;
            transition: color 0.5s, border-bottom 0.5s;
            padding-bottom: 5px;
            font-family: 'Roboto', sans-serif;
        }

        .nav-left a:hover,
        .nav-left .active {
            color: #4db1ff;
            border-bottom: 2px solid #4db1ff;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #444;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            margin-top: 0.5rem;
            min-width: 160px;
        }

        .dropdown-content a {
            color: white;
            padding: 0.5rem 1rem;
            display: block;
            text-decoration: none;
        }

        .dropdown-content a:hover {
            background-color: #555;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .server-links {
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            color: white;
            align-self: flex-end;
            width: fit-content;
            position: absolute;
            right: 0;
            bottom: 40%;
            flex-wrap: wrap;
        }

        .server-links h3 {
            margin: 0 0 10px 0;
        }

        .server-links ul {
            list-style: none;
            padding: 0;
        }

        .server-links li {
            margin: 5px 0;
        }

        .server-links a {
            color: #4db1ff;
            text-decoration: none;
            transition: color 0.3s;
        }

        .server-links a:hover {
            color: #ffffff;
            text-decoration: underline;
        }

        .links-btn {
            transform: translateY(-50%);
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            z-index: 10;
        }

        .iframe-container {
            position: fixed;
            top: 50%;
            right: 80px;
            width: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
            transform: translateY(-50%);
            transition: width 0.5s ease, height 0.5s ease, opacity 0.5s ease;
            z-index: 100;
            border: 7px solid #333;
            cursor: pointer;
            border-radius: 25px;
        }

        .iframe-container.show {
            width: 600px;
            height: 600px;
            opacity: 1;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #backupStatus {
            font-family: Arial, sans-serif;
            padding: 10px;
            margin: 0;
        }

        .backup-header {
            display: flex;
            align-items: center;
            font-size: 52px;
            margin-bottom: 5px;
        }

        .creatingBackup {
            font-size: 52px !important;
            font-weight: bold;
            margin-right: 10px;
        }

        #sizeInfo {
            font-size: 32px;
            margin-left: 5px;
        }

        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 10px;
        }

        .progress-bar-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .spinner {
            margin-right: 15px;
            width: 40px;
            height: 40px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .backup-progress {
            height: 100%;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            border-radius: 10px 0 0 10px;
            transition: width 0.5s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .eta {
            align-self: flex-end;
            font-size: 22px;
            font-weight: bold;
            margin-top: 5px;
        }

        #backupStatus p {
            font-size: 20px;
            margin: 5px 0;
        }

        .progress-bar-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .size-info {
            display: flex;
            flex-direction: column;
            margin: 25px 0;
            font-size: 16px;
            text-align: left;
        }

        .filter {
            position: relative;
            display: inline-block;
        }

        .filter-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        .filter-content {
            display: none;
            position: absolute;
            background-color: black;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(3, 2, 2, 0.8);
            opacity: 0.67;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            right: 20px;
        }

        .filter-content label {
            padding: 8px 16px;
            cursor: pointer;
            display: block;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            color: #fff;

        }

        .filter-content label:hover {
            background-color: #ddd;
        }

        .filter-show {
            display: block;
        }

        .filter-checkbox {
            color: #000;
        }

        @media (max-width: 768px) {
            .console {
                width: 40vh;
                height: 20vh;
                min-width: 40vh;
                min-height: 50vh;
                background-color: black;
                color: white;
                padding: 20px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 16px;
                overflow-y: auto;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(3, 2, 2, 0.8);
                opacity: 0.67;
                margin-top: 20px;
                position: absolute;
                top: 9%;
                left: 7%;
                white-space: pre-wrap;
                display: block;
            }


            .button-container {
                gap: 100px;
                margin-left: 0;
                padding-right: 0;
                position: absolute;
                bottom: 0;
                margin-left: -50%;
            }

            .command-label {
                width: 90%;
                left: 5%;
                bottom: 20%;
            }

            .server-links {
                flex-direction: column;
                gap: 10px;
                display: flex;
                justify-content: center;
                bottom: 7%;
                padding: 10px;
            }

            .server-links h3 {
                margin-bottom: 40px;
            }

            .filter-content {
                bottom: -160%;
                right: 120%;
            }

            ::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 10px;
                height: 30px;
            }

            ::-webkit-scrollbar {
                width: 20px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <ul class="nav-left">
            <li><a href="/">Home</a></li>
            <li><a href="/console.html" class="active">Server</a></li>
            <li><a href="login.html">Login</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li class="dropdown" id="adminDropdown" style="display: none;">
                <a href="#">Admin Tools</a>
                <div class="dropdown-content">
                    <a href="terminal.html">Linux</a>
                    <a href="users.html">Users</a>
                    <a href="user-management.html">User Management</a>
                </div>
            </li>
        </ul>
    </nav>

    <div>


        <div class="console" id="console"></div>
        <div>
            <form onsubmit="sendCommand(event)">
                <input type="text" name="command" autocomplete="off" placeholder="/ Enter Command" required
                    class="command-label" />
            </form>
            <div class="button-container">
                <div class="text-box">
                    <a href="#" onclick="return false;" type="button" id="btn-start"
                        class="btn btn-animate btn-start">Start</a>
                </div>
                <div class="text-box">
                    <a href="#" onclick="return false;" type="button" id="btn-restart"
                        class="btn btn-animate btn-restart">Restart</a>
                </div>
                <div class="text-box">
                    <a href="#" onclick="return false;" type="button" id="btn-stop"
                        class="btn btn-animate btn-stop">Stop</a>
                </div>
                <div class="text-box">
                    <a href="#" onclick="return false;" type="button" id="btn-kill"
                        class="btn btn-animate btn-kill">Kill</a>
                </div>

            </div>
        </div>
    </div>
    <h3 class="server-links" onclick="hideActions()" style="display: block;" id="serverText">Server Actions</h3>
    <div class="server-links" style="display: none;" id="serverLinks">
        <h3 onclick="hideActions()">Server Actions</h3>
        <ul>
            <li><button class="backup-btn links-btn" onclick="backups()">Backups</button></li>
            <div class="filter-container">
                Messages</label>
                <div style="position: relative;">
                    <button class="filter-button" id="filter-toggle-button">Filters</button>
                    <div class="filter-content" id="filter-dropdown">
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-joinorleft" class="filter-checkbox" value="joinorleft" checked>Join Or
                            Left</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-cmdexec" class="filter-checkbox" value="cmdexec" checked> Command
                            Executions</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-deathmsg" class="filter-checkbox" value="deathmsg" checked> Death
                            Messages</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-warn" class="filter-checkbox" value="warn" checked> Warnings</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-error" class="filter-checkbox" value="error" checked><br> Errors</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-info" class="filter-checkbox" value="info" checked> Information</label>
                        <label class="filter-label"><input type="checkbox" onclick="addFilter(this.value, this.checked)"
                                id="filter-other" class="filter-checkbox" value="other" checked> <br>Other</label>
                    </div>
                </div>
            </div>
        </ul>
    </div>
    </div>


</body>

</html>
<script>

    const filterButton = document.getElementById('filter-toggle-button');
    const filterDropdown = document.getElementById('filter-dropdown');
    filterButton.addEventListener('click', () => {
        filterDropdown.classList.toggle('filter-show');
    });

    document.addEventListener('click', (event) => {
        if (!filterButton.contains(event.target) && !filterDropdown.contains(event.target)) {
            filterDropdown.classList.remove('filter-show');
        }
    });

    const token = sessionStorage.getItem('authToken');
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    function hideActions() {
        const actionsDiv = document.getElementById('serverLinks');
        const actionsText = document.getElementById('serverText');
        if (actionsDiv.style.display != 'none') {
            actionsDiv.style.display = 'none'
            actionsText.style.display = 'block'
        } else {
            actionsDiv.style.display = 'block'
            actionsText.style.display = 'none'
        }

    }

    if (token) {
        const userData = parseJwt(token);
        if (userData && userData.role === 'admin') {
            document.getElementById('adminDropdown').style.display = 'block';
        }
    }

    function sendCommand(event) {
        event.preventDefault();

        const commandInput = document.querySelector('input[name="command"]');
        const command = commandInput.value;
        const token = sessionStorage.getItem('authToken');
        if (token) {
            fetch('/api/mc/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `command=${encodeURIComponent(command)}`
            })
                .then(response => {
                    if (!response.ok) {

                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'An unknown error occurred');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type == 'Not Running') {
                        alert('Server is currently not running');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                })
                .finally(() => {
                    commandInput.value = '';
                });
        } else {
            alert('You need to be logged in to do that!');
            commandInput.value = '';
        }
    }

    async function getPublicIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error('Error fetching IP address:', error);
            return null;
        }
    }

    async function sendIPToServer(ip, url) {
        const token = sessionStorage.getItem('authToken');

        try {
            await fetch('/api/receive-ip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ ip, url })
            });

        } catch (error) {
            console.error('Error sending IP address to server:', error);

        }
    }

    async function initialize() {
        try {
            checkBackupStatus();
            connectWebSocket();

            const ip = await getPublicIP();
            if (ip) {
                await sendIPToServer(ip, window.location.href);
            }
        } catch (error) {
            console.error('Fehler beim Initialisieren:', error);
        }
    }

    window.onload = initialize;


    document.getElementById('btn-start').addEventListener('click', async (e) => {
        fetch('/api/mc/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',

            },
        }).then(() => {
            setTimeout(connectWebSocket(), 2000);
        }
        )
    });

    document.getElementById('btn-stop').addEventListener('click', async (e) => {
        const token = sessionStorage.getItem('authToken');
        if (token) {
            fetch('/api/mc/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `command=stop`
            })
                .then(response => {
                    if (!response.ok) {

                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'An unknown error occurred');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type == 'Not Running') {
                        alert('Server is currently not running');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                })
                .finally(() => {
                    commandInput.value = '';
                });
        } else {
            alert('You need to be logged in to do that!');
            commandInput.value = '';
        }
    });


    document.getElementById('btn-restart').addEventListener('click', async (e) => {
        const token = sessionStorage.getItem('authToken');
        if (token) {
            fetch('/api/mc/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `command=restart`
            })
                .then(response => {
                    if (!response.ok) {

                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'An unknown error occurred');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type == 'Not Running') {
                        alert('Server is currently not running');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                })
                .finally(() => {
                    commandInput.value = '';
                });
        } else {
            alert('You need to be logged in to do that!');
            commandInput.value = '';
        }
    });
    document.getElementById('btn-restart').addEventListener('click', async (e) => {
        const token = sessionStorage.getItem('authToken');
        if (token) {
            fetch('/api/mc/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `command=restart`
            })
                .then(response => {
                    if (!response.ok) {

                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'An unknown error occurred');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type == 'Not Running') {
                        alert('Server is currently not running');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                })
                .finally(() => {
                    commandInput.value = '';
                });
        } else {
            alert('You need to be logged in to do that!');
            commandInput.value = '';
        }
    });
    document.getElementById('btn-kill').addEventListener('click', async (e) => {
        const token = sessionStorage.getItem('authToken');
        if (token) {
            fetch('/api/mc/kill', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `command=restart`
            })
                .then(response => {
                    if (!response.ok) {

                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'An unknown error occurred');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type == 'Not Running') {
                        alert('Server is currently not running');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                })
                .finally(() => {
                    commandInput.value = '';
                });
        } else {
            alert('You need to be logged in to do that!');
            commandInput.value = '';
        }
    });

    const iframe = document.getElementById('bluemap-iframe');

    let wasMakingBackup = false;
    function checkBackupStatus() {
        displayBackup();
        setInterval(displayBackup, 151100);
    }

    function displayBackup() {
        fetch('/api/backups/status', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('authToken')}`
            }
        })
            .then(response => response.json())
            .then(data => {
                const consoleElement = document.getElementById('console');
                const commandInput = document.querySelector('input[name="command"]');
                if (data.progress && data.progress !== '100%' && data.progress != 'N/A') {
                    isBackup = true;
                    progress = data.progress.replace('%', '');
                    totalsize = ((formatString(data.size, true) / progress * 100 * 0.75).toFixed(2) + " " + formatString(data.size, false));
                    commandInput.disabled = true;
                    consoleElement.innerHTML = `
                    <div class="backupStatus" id="backupStatus">
                        <div class="backup-header">
                            <p class="creatingBackup">Creating Backup...</p>
                            <div class="size-info">
                                <p id="sizeInfo">Size: ${data.size}</p>
                                <p id="totalSizeInfo">Total: ${totalsize}</p>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-container">
                                <!-- Spinner on the left side -->
                                <div class="spinner" id="loadingSpinner" aria-label="Loading..."></div>
                                
                                <progress class="backup-progress" id="backup-progress" value="${progress}" max="100" style="width: 100%; height: 30px;"></progress>
                                <p class="progress-percentage" id="progressPercentage">${progress}%</p>
                            </div>
                            <p class="eta" id="eta">ETA: ${data.eta}</p>
                        </div>
                    
                        <p>I dont know what could be here</p>
                    </div>
                    `;
                    wasMakingBackup = true;
                } else if (data.progress === '100%') {
                    consoleElement.innerHTML = '<p>Backup erfolgreich abgeschlossen!</p>';
                    wasMakingBackup = true;
                } else {
                    isBackup = false;
                    if (wasMakingBackup) {
                        consoleElement.innerHTML = '';
                        wasMakingBackup = false;
                        commandInput.disabled = false;

                        setTimeout(connectWebSocket(), 15000);
                    }
                }
            })
            .catch(err => {
                console.error('Fehler beim Abrufen des Backup-Status:', err);
            });
    };



    function formatString(input, numbers) {
        if (numbers) {
            let onlyNumbersAndSymbols = input.replace(/[a-zA-Z]/g, "");

            let formattedString = onlyNumbersAndSymbols.replace(/,/g, ".");

            return formattedString;
        } else {
            let onlyLetters = input.replace(/[1-9]/g, "");

            let formattedString = onlyLetters.replace(",", "");

            return formattedString;
        }
    }


    function openIframeInNewTab() {
        var iframe = document.getElementById('bluemap-iframe');
        var iframeSrc = iframe.src;
        window.open(iframeSrc, '_blank');
    }

    document.addEventListener('fullscreenchange', function () {
        if (document.fullscreenElement === iframe) {
            openIframeInNewTab();
        }
    });
    function backups() {
        window.location.href = '/backups.html'
    }

    const regexList = {
        chatRegex: /[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?.*\[.*\].*<[A-Za-z0-9]+>\s+[A-Za-z0-9]+/i,
        warnRegex: /[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?.*(WARN|WARNING)/i,
        errorRegex: /[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?.*(ERR|ERROR)/i,
        infoRegex: /[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?.*(INFO)/i,
        joinRegex: /\[[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?\] \[[^\]]+\]: (\[[^\]]*\] )?[A-Za-z0-9]+(\s\[[^\]]*\])? joined the game/i,
        leftRegex: /\[[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?\] \[[^\]]+\]: (\[[^\]]*\] )?[A-Za-z0-9]+(\s\[[^\]]*\])? left the game/i,
        commandRegex: /\[[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?\] \[[^\]]+\]: [A-Za-z0-9]+ issued server command: \/[^ ]+/i,

    };

    let socket;
    let isBackup = false;
    let receivedMessages = [];
    let filterTypes = ['all', 'joinorleft', 'cmdexec', 'deathmsg', 'warn', 'error', 'info', 'other'];

    function connectWebSocket() {
        socket = new WebSocket('ws://' + window.location.origin.replace('http://', '') + '/ws1');

        socket.onmessage = function (event) {
            if (!isBackup) {
                const outputDiv = document.getElementById('console');
                const lines = event.data.split('\n');
                lines.forEach(line => {
                    line = line.trim();

                    if (line.length === 0) return;

                    if (!receivedMessages.includes(line)) {
                        const lineElement = document.createElement('div');
                        if (regexList.joinRegex.test(line) || regexList.leftRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'joinorleft');
                            //lineElement.style.color = 'lime'
                        } else if (regexList.chatRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'chatmsg');
                            //lineElement.style.color = 'cyan';
                        } else if (regexList.commandRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'cmdexec');
                            //lineElement.style.color = 'orange'
                        } else if (testDeathMessage(line)) {
                            lineElement.setAttribute('data-type', 'deathmsg');
                            //lineElement.style.color = 'red'
                        } else if (regexList.warnRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'warn');
                            //lineElement.style.color = 'yellow';
                        } else if (regexList.errorRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'error');
                            //lineElement.style.color = 'darkred';
                        } else if (regexList.infoRegex.test(line)) {
                            lineElement.setAttribute('data-type', 'info');
                            //lineElement.style.color = 'white';
                        } else {
                            lineElement.setAttribute('data-type', 'other');
                            //lineElement.style.color = 'white';
                        }

                        lineElement.textContent = line;
                        lineElement.classList.add("message-div");
                        lineElement.id = 'message'
                        lineElement.classList.add('new-message');
                        outputDiv.appendChild(lineElement);
                        //filterMessages();

                        setTimeout(() => {
                            lineElement.classList.remove('new-message');
                        }, 1000);

                        receivedMessages.push(line);
                    }
                });

                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        };

        socket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        socket.onclose = function () {
            console.log('WebSocket connection closed. Reconnecting in 1 second...');
            setTimeout(connectWebSocket, 1000);
        };
    }
    function testDeathMessage(message) {
        const deathMessageRegex = {
            // **Cactus**
            cactus: /was pricked to death/,
            cactusEscape: /walked into a cactus while trying to escape [A-Za-z0-9_]+/,

            // **Drowning**
            drown: /drowned/,
            drownEscape: /drowned while trying to escape [A-Za-z0-9_]+/,

            // **Drying Out**
            dryOut: /died from dehydration/,
            dryOutEscape: /died from dehydration while trying to escape [A-Za-z0-9_]+/,

            // **Elytra (Fly into Wall)**
            elytra: /experienced kinetic energy/,
            elytraEscape: /experienced kinetic energy while trying to escape [A-Za-z0-9_]+/,

            // **Explosions**
            explosion: /blew up/,
            explosionPlayer: /was blown up by [A-Za-z0-9_]+/,
            explosionPlayerItem: /was blown up by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,

            // **Falling**
            fall: /hit the ground too hard/,
            fallEscape: /hit the ground too hard while trying to escape [A-Za-z0-9_]+/,
            fallHigh: /fell from a high place/,
            fallLadder: /fell off a ladder/,
            fallVines: /fell off some vines/,
            fallWeepingVines: /fell off some weeping vines/,
            fallTwistingVines: /fell off some twisting vines/,
            fallScaffolding: /fell off scaffolding/,
            fallClimbing: /fell while climbing/,
            fallDoomed: /was doomed to fall/,
            fallDoomedPlayer: /was doomed to fall by [A-Za-z0-9_]+/,
            fallDoomedPlayerItem: /was doomed to fall by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,
            fallStalagmite: /was impaled on a stalagmite/,
            fallStalagmiteEscape: /was impaled on a stalagmite while fighting [A-Za-z0-9_]+/,

            // **Falling Blocks**
            fallingAnvil: /was squashed by a falling anvil/,
            fallingBlock: /was squashed by a falling block/,
            fallingStalactite: /was skewered by a falling stalactite/,

            // **Fire**
            fire: /went up in flames/,
            fireEscape: /walked into fire while fighting [A-Za-z0-9_]+/,
            fireBurn: /burned to death/,
            fireBurnEscape: /was burned to a crisp while fighting [A-Za-z0-9_]+/,

            // **Firework Rockets**
            firework: /went off with a bang/,
            fireworkPlayerItem: /went off with a bang due to a firework fired from [A-Za-z0-9_]+ by [A-Za-z0-9_]+/,

            // **Lava**
            lava: /tried to swim in lava/,
            lavaEscape: /tried to swim in lava to escape [A-Za-z0-9_]+/,

            // **Lightning**
            lightning: /was struck by lightning/,
            lightningEscape: /was struck by lightning while fighting [A-Za-z0-9_]+/,

            // **Magma Block**
            magma: /discovered the floor was lava/,
            magmaEscape: /walked into the danger zone due to [A-Za-z0-9_]+/,

            // **Magic**
            magic: /was killed by magic/,
            magicEscape: /was killed by magic while trying to escape [A-Za-z0-9_]+/,
            magicPlayer: /was killed by [A-Za-z0-9_]+ using magic/,
            magicPlayerItem: /was killed by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,

            // **Players and Mobs**
            playerKill: /was slain by [A-Za-z0-9_]+/,
            playerKillItem: /was slain by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,
            beeKill: /was stung to death/,
            beeKillPlayerItem: /was stung to death by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,
            wardenKill: /was obliterated by a sonically-charged shriek/,
            wardenKillEscape: /was obliterated by a sonically-charged shriek while trying to escape [A-Za-z0-9_]+ wielding [A-Za-z0-9_]+/,
            maceKill: /was smashed by [A-Za-z0-9_]+/,
            maceKillItem: /was smashed by [A-Za-z0-9_]+ with [A-Za-z0-9_]+/,

            // **Projectiles**
            arrowKill: /was shot by [A-Za-z0-9_]+/,
            arrowKillItem: /was shot by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,
            fireballKill: /was fireballed by [A-Za-z0-9_]+/,
            fireballKillItem: /was fireballed by [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,
            tridentKill: /was impaled by [A-Za-z0-9_]+/,
            tridentKillItem: /was impaled by [A-Za-z0-9_]+ with [A-Za-z0-9_]+/,
            witherSkullKill: /was shot by a skull from [A-Za-z0-9_]+/,
            witherSkullKillItem: /was shot by a skull from [A-Za-z0-9_]+ using [A-Za-z0-9_]+/,

            // **Starving**
            starve: /starved to death/,
            starveEscape: /starved to death while fighting [A-Za-z0-9_]+/,

            // **Suffocation**
            suffocate: /suffocated in a wall/,
            suffocateEscape: /suffocated in a wall while fighting [A-Za-z0-9_]+/,
            cramming: /was squished too much/,
            crammingPlayer: /was squashed by [A-Za-z0-9_]+/,
            border: /left the confines of this world/,
            borderEscape: /left the confines of this world while fighting [A-Za-z0-9_]+/,

            // **Sweet Berry Bushes**
            sweetBerryBush: /was poked to death by a sweet berry bush/,
            sweetBerryBushEscape: /was poked to death by a sweet berry bush while trying to escape [A-Za-z0-9_]+/,

            // **Thorns Enchantment**
            thorns: /was killed while trying to hurt [A-Za-z0-9_]+/,
            thornsItem: /was killed by [A-Za-z0-9_]+ while trying to hurt [A-Za-z0-9_]+/,

            // **Trident**
            tridentKill: /was impaled by [A-Za-z0-9_]+/,
            tridentKillItem: /was impaled by [A-Za-z0-9_]+ with [A-Za-z0-9_]+/,

            // **Void**
            void: /fell out of the world/,
            voidEscape: /didn't want to live in the same world as [A-Za-z0-9_]+/,

            // **Wither Effect**
            wither: /withered away/,
            witherEscape: /withered away while fighting [A-Za-z0-9_]+/,

            // **Generic Death**
            genericDeath: /died/,
            genericDeathPlayer: /died because of [A-Za-z0-9_]+/,
            killCommand: /was killed/,
            killCommandEscape: /was killed while fighting [A-Za-z0-9_]+/,
        };
        for (const [deathType, regex] of Object.entries(deathMessageRegex)) {
            if (regex.test(message)) {
                return true;
            }
        }
        return false;
    }

    function addFilter(value, isChecked) {
        if (isChecked) {
            if (!filterTypes.includes(value)) {
                filterTypes.push(value);
                console.log(`Filter hinzugefügt: ${value}`);
            }
        } else {
            filterTypes = filterTypes.filter(filter => filter !== value);
        }
        filterMessages()
    }

    function filterMessages(types = filterTypes) {
        const messages = document.querySelectorAll('#console #message');

        messages.forEach((message) => {
            console.log(message.getAttribute('data-type'))
            if (types.includes(message.getAttribute('data-type'))) {
                message.style.display = 'block';
            } else {
                message.style.display = 'none';
            }
        });
    }

</script>
</body>

</html>